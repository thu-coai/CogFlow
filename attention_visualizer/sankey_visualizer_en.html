<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Sankey Diagram Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .sankey-link {
            transition: opacity 0.2s ease-in-out;
        }
        .sankey-link:hover {
            opacity: 0.9 !important;
            cursor: pointer;
        }
        .sankey-node rect {
            stroke: #333;
            stroke-width: 1px;
        }
        .sankey-node text {
            /* Removed pointer-events: none; to ensure labels are clickable */
            text-shadow: 0 1px 0 #fff;
        }
        .sankey-node .label-text:hover {
             cursor: pointer;
             font-weight: bold;
        }
        #editor-panel {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-700">Interactive Sankey Diagram Editor</h1>
            <p class="text-gray-500 mt-2">Load a `.json` file generated by the Python script, then click on links or node labels in the diagram to edit.</p>
        </header>

        <div class="max-w-xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                <div>
                    <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2">1. Select Data File:</label>
                    <input type="file" id="file-input" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">2. Export File:</label>
                    <div class="flex space-x-2">
                        <button id="export-json-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            Export JSON
                        </button>
                        <button id="export-svg-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            Export SVG
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Global Settings Panel -->
        <div id="settings-panel" class="max-w-xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Chart Settings</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                <div>
                    <label for="margin-slider" class="block text-sm font-medium text-gray-700">Side Margin: <span id="margin-value">150</span>px</label>
                    <input type="range" id="margin-slider" min="50" max="800" step="10" value="150" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div>
                    <label for="font-size-slider" class="block text-sm font-medium text-gray-700">Font Size: <span id="font-size-value">12</span>px</label>
                    <input type="range" id="font-size-slider" min="8" max="30" step="1" value="12" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                 <div>
                    <label for="font-family-select" class="block text-sm font-medium text-gray-700">Font Family</label>
                    <select id="font-family-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif">System Sans-serif</option>
                        <option value="serif">System Serif</option>
                        <option value="monospace">System Monospace</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Layout</label>
                    <button id="swap-columns-btn" class="mt-1 w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">
                        Swap Left/Right Columns
                    </button>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Label Display</label>
                    <div class="flex items-center space-x-8">
                        <label for="show-left-labels" class="flex items-center cursor-pointer">
                            <input type="checkbox" id="show-left-labels" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                            <span class="ml-2 text-gray-700">Show Left Labels</span>
                        </label>
                        <label for="show-right-labels" class="flex items-center cursor-pointer">
                            <input type="checkbox" id="show-right-labels" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked>
                            <span class="ml-2 text-gray-700">Show Right Labels</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div id="chart-container" class="bg-white rounded-lg shadow-md p-4 relative min-h-[600px] overflow-hidden">
             <div id="placeholder" class="absolute inset-0 flex items-center justify-center">
                <p class="text-gray-400 text-lg">Please load a JSON data file to render the chart</p>
            </div>
            <svg id="sankey-chart"></svg>
        </div>
    </div>

    <!-- Editor Panel (initially hidden) -->
    <div id="editor-panel" class="fixed top-4 right-4 bg-white p-6 rounded-lg border border-gray-200 w-80 opacity-0 transform translate-x-12 pointer-events-none">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Edit Link Style</h3>
            <button id="close-panel-btn" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
        </div>
        <p id="editing-label" class="text-sm text-gray-500 mb-4 truncate" title=""></p>
        
        <div class="space-y-4">
            <div>
                <label for="color-picker" class="block text-sm font-medium text-gray-700">Main Color</label>
                <input type="color" id="color-picker" class="mt-1 p-1 h-10 w-full block border-gray-300 rounded-md">
            </div>
            <div>
                <label for="opacity-slider" class="block text-sm font-medium text-gray-700">Opacity: <span id="opacity-value">0.5</span></label>
                <input type="range" id="opacity-slider" min="0" max="1" step="0.05" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <div>
                <label for="width-slider" class="block text-sm font-medium text-gray-700">Width: <span id="width-value">1</span>px</label>
                <input type="range" id="width-slider" min="1" max="50" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="border-t border-gray-200 pt-4 mt-4">
                <h4 class="text-sm font-semibold text-gray-500 mb-2">Border Style</h4>
                <div>
                    <label for="border-color-picker" class="block text-sm font-medium text-gray-700">Border Color</label>
                    <input type="color" id="border-color-picker" class="mt-1 p-1 h-10 w-full block border-gray-300 rounded-md">
                </div>
                <div class="mt-4">
                    <label for="border-width-slider" class="block text-sm font-medium text-gray-700">Border Width: <span id="border-width-value">0</span>px</label>
                    <input type="range" id="border-width-slider" min="0" max="10" step="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('file-input');
        const chartContainer = document.getElementById('chart-container');
        const svg = d3.select("#sankey-chart");
        const placeholder = document.getElementById('placeholder');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const exportSvgBtn = document.getElementById('export-svg-btn');
        const editorPanel = document.getElementById('editor-panel');
        const closePanelBtn = document.getElementById('close-panel-btn');
        const colorPicker = document.getElementById('color-picker');
        const opacitySlider = document.getElementById('opacity-slider');
        const opacityValueSpan = document.getElementById('opacity-value');
        const widthSlider = document.getElementById('width-slider');
        const widthValueSpan = document.getElementById('width-value');
        const editingLabel = document.getElementById('editing-label');
        const borderColorPicker = document.getElementById('border-color-picker');
        const borderWidthSlider = document.getElementById('border-width-slider');
        const borderWidthValueSpan = document.getElementById('border-width-value');
        const marginSlider = document.getElementById('margin-slider');
        const marginValueSpan = document.getElementById('margin-value');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeValueSpan = document.getElementById('font-size-value');
        const fontFamilySelect = document.getElementById('font-family-select');
        const swapColumnsBtn = document.getElementById('swap-columns-btn');
        const showLeftLabelsCheckbox = document.getElementById('show-left-labels');
        const showRightLabelsCheckbox = document.getElementById('show-right-labels');


        let selectedLinkData = null;
        let currentFileName = 'sankey_data_modified.json';
        let chartSettings = {
            horizontalMargin: 150,
            fontSize: 12,
            fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif",
            isSwapped: false,
            showLeftLabels: true,
            showRightLabels: true,
        };


        fileInput.addEventListener('change', handleFileSelect);
        closePanelBtn.addEventListener('click', hideEditorPanel);
        exportJsonBtn.addEventListener('click', exportModifiedJSON);
        exportSvgBtn.addEventListener('click', exportSVG);
        
        colorPicker.addEventListener('input', () => updateLinkStyle('color', colorPicker.value));
        opacitySlider.addEventListener('input', () => {
            const val = parseFloat(opacitySlider.value);
            opacityValueSpan.textContent = val.toFixed(2);
            updateLinkStyle('opacity', val);
        });
        widthSlider.addEventListener('input', () => {
            const val = parseInt(widthSlider.value);
            widthValueSpan.textContent = val;
            updateLinkStyle('width', val);
        });
        borderColorPicker.addEventListener('input', () => updateLinkStyle('borderColor', borderColorPicker.value));
        borderWidthSlider.addEventListener('input', () => {
            const val = parseFloat(borderWidthSlider.value);
            borderWidthValueSpan.textContent = val.toFixed(1);
            updateLinkStyle('borderWidth', val);
        });
        
        marginSlider.addEventListener('input', () => {
            const val = parseInt(marginSlider.value);
            marginValueSpan.textContent = val;
            chartSettings.horizontalMargin = val;
            if (svg.node().__data__) {
                renderSankey(svg.node().__data__);
            }
        });

        fontSizeSlider.addEventListener('input', () => {
            const val = parseInt(fontSizeSlider.value);
            fontSizeValueSpan.textContent = val;
            chartSettings.fontSize = val;
            if (svg.node().__data__) {
                renderSankey(svg.node().__data__);
            }
        });

        fontFamilySelect.addEventListener('change', () => {
            const val = fontFamilySelect.value;
            chartSettings.fontFamily = val;
            if (svg.node().__data__) {
                renderSankey(svg.node().__data__);
            }
        });

        swapColumnsBtn.addEventListener('click', () => {
            chartSettings.isSwapped = !chartSettings.isSwapped;
            if (svg.node().__data__) {
                renderSankey(svg.node().__data__);
            }
        });
        
        showLeftLabelsCheckbox.addEventListener('change', () => {
            chartSettings.showLeftLabels = showLeftLabelsCheckbox.checked;
            if (svg.node().__data__) {
                renderSankey(svg.node().__data__);
            }
        });

        showRightLabelsCheckbox.addEventListener('change', () => {
            chartSettings.showRightLabels = showRightLabelsCheckbox.checked;
            if (svg.node().__data__) {
                renderSankey(svg.node().__data__);
            }
        });


        function sankeyLinkHorizontal() {
            function link(d) {
                const sx = d.source.x;
                const tx = d.target.x;
                const sy = d.source.y0 + d.width / 2;
                const ty = d.target.y0 + d.width / 2;
                const halfx = (tx - sx) / 2;
                return `M${sx},${sy}C${sx + halfx},${sy} ${tx - halfx},${ty} ${tx},${ty}`;
            }
            return link;
        }

        function renderSankey(data) {
            svg.selectAll("*").remove();

            const defs = svg.append("defs");
            const mainGroup = svg.append("g").attr("id", "sankey-content");
            
            const width = chartContainer.clientWidth;
            const height = Math.max(600, data.nodes.length * 30);
            svg.attr("width", width).attr("height", height);

            const margin = { 
                top: 20, 
                right: chartSettings.horizontalMargin, 
                bottom: 20, 
                left: chartSettings.horizontalMargin 
            };
            const nodeWidth = 15;
            const nodePadding = 10;
            
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const nodeById = new Map(data.nodes.map(d => [d.id, d]));

            // Define column positions based on swap state
            const sourceX0 = chartSettings.isSwapped ? chartWidth + margin.left : margin.left;
            const sourceX1 = sourceX0 + nodeWidth;
            const targetX0 = chartSettings.isSwapped ? margin.left : chartWidth + margin.left;

            data.nodes.forEach(node => {
                node.outgoingValue = d3.sum(data.links.filter(l => l.source === node.id), l => l.value);
                node.incomingValue = d3.sum(data.links.filter(l => l.target === node.id), l => l.value);
                node.value = Math.max(node.outgoingValue, node.incomingValue);
            });

            const totalNodeValue = d3.sum(data.nodes, d => d.value);
            const availableHeight = chartHeight - (data.nodes.length - 1) * nodePadding;
            const heightScale = totalNodeValue > 0 ? availableHeight / totalNodeValue : 0;

            let yPos = margin.top;
            data.nodes.forEach(node => {
                node.height = node.value * heightScale;
                node.x0 = sourceX0; // All nodes conceptually start on the source side for y-calculation
                node.x1 = sourceX1;
                node.y0 = yPos;
                node.y1 = yPos + node.height;
                yPos += node.height + nodePadding;
                node.sourceYOffset = 0;
                node.targetYOffset = 0;
            });
            
            const linksForDrawing = data.links.map(link => {
                const sourceNode = nodeById.get(link.source);
                const targetNode = nodeById.get(link.target);
                const linkWidth = link.value * heightScale;
                
                const drawableLink = {
                    ...link,
                    width: linkWidth,
                    sourcePos: { x: sourceX1, y0: sourceNode.y0 + sourceNode.sourceYOffset },
                    targetPos: { x: targetX0, y0: targetNode.y0 + targetNode.targetYOffset }
                };
                sourceNode.sourceYOffset += linkWidth;
                targetNode.targetYOffset += linkWidth;
                return drawableLink;
            });
            
            const link = mainGroup.append("g")
                .selectAll("g")
                .data(linksForDrawing)
                .join("g")
                .attr("class", "sankey-link")
                .on("click", (event, d) => showEditorPanel(d));
            
            link.each(function(d, i) {
                const gradient = defs.append("linearGradient")
                    .attr("id", `gradient-${i}`)
                    .attr("gradientUnits", "userSpaceOnUse")
                    .attr("x1", d.sourcePos.x)
                    .attr("x2", d.targetPos.x);
                gradient.append("stop").attr("offset", "0%").attr("stop-color", d.style.color);
                gradient.append("stop").attr("offset", "100%").attr("stop-color", d.style.color);
            });

            // Draw border path (behind)
            link.append("path")
                .attr("d", d => sankeyLinkHorizontal()({ source: d.sourcePos, target: d.targetPos, width: d.width }))
                .attr("stroke", d => d.style.borderColor)
                .attr("stroke-width", d => d.style.borderWidth > 0 ? Math.max(1, d.width + d.style.borderWidth * 2) : 0)
                .attr("stroke-opacity", d => d.style.borderWidth > 0 ? d.style.opacity : 0)
                .attr("fill", "none");

            // Draw main path (on top)
            link.append("path")
                .attr("d", d => sankeyLinkHorizontal()({ source: d.sourcePos, target: d.targetPos, width: d.width }))
                .attr("stroke", (d, i) => `url(#gradient-${i})`)
                .attr("stroke-width", d => Math.max(1, d.width))
                .attr("stroke-opacity", d => d.style.opacity)
                .attr("fill", "none");

            link.append("title")
                .text(d => `${nodeById.get(d.source).label} → ${nodeById.get(d.target).label}\nValue: ${d.value.toPrecision(3)}`);

            const node = mainGroup.append("g").selectAll("g").data(data.nodes).join("g").attr("class", "sankey-node");
            // Draw node rectangles for both columns
            node.append("rect").attr("x", d => sourceX0).attr("y", d => d.y0).attr("height", d => d.y1 - d.y0).attr("width", nodeWidth).attr("fill", d => d.color);
            node.append("rect").attr("x", d => targetX0).attr("y", d => d.y0).attr("height", d => d.y1 - d.y0).attr("width", nodeWidth).attr("fill", d => d.color);
            
            const addLabel = (selection, anchor, xPos) => {
                selection
                    .attr("class", "label-text")
                    .attr("x", xPos)
                    .attr("y", d => (d.y0 + d.y1) / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", anchor)
                    .style("font-size", `${chartSettings.fontSize}px`)
                    .style("font-family", chartSettings.fontFamily)
                    .style("cursor", "pointer")
                    .each(function(d) {
                        const text = d3.select(this);
                        text.text(null); // Clear existing text
                        const parts = d.label.split('_');
                        text.append('tspan').text(parts[0]);
                        if (parts.length > 1) {
                            text.append('tspan')
                                .attr('baseline-shift', 'sub')
                                .style('font-size', '75%')
                                .text(parts.slice(1).join('_'));
                        }
                    })
                    .on("click", (event, d) => {
                        event.stopPropagation();
                        editNodeLabel(event, d);
                    });
            };

            const leftColumnNodeX = chartSettings.isSwapped ? targetX0 : sourceX0;
            const rightColumnNodeX = chartSettings.isSwapped ? sourceX0 : targetX0;

            if (chartSettings.showLeftLabels) {
                const leftLabelX = leftColumnNodeX - 6;
                const leftLabelAnchor = "end";
                node.append("text").call(addLabel, leftLabelAnchor, leftLabelX);
            }
            if (chartSettings.showRightLabels) {
                const rightLabelX = rightColumnNodeX + nodeWidth + 6;
                const rightLabelAnchor = "start";
                node.append("text").call(addLabel, rightLabelAnchor, rightLabelX);
            }
        }
        
        function editNodeLabel(event, d) {
            const textElement = d3.select(event.currentTarget);
            const parentNode = d3.select(event.currentTarget.parentNode);
            textElement.style("display", "none");

            const textBBox = textElement.node().getBBox();
            const foreignObject = parentNode.append("foreignObject")
                .attr("x", textBBox.x)
                .attr("y", textBBox.y)
                .attr("width", Math.max(100, textBBox.width + 40))
                .attr("height", Math.max(20, textBBox.height + 4));

            const input = foreignObject.append("xhtml:input")
                .attr("type", "text")
                .property("value", d.label)
                .style("width", "100%")
                .style("height", "100%")
                .style("font-size", `${chartSettings.fontSize}px`)
                .style("font-family", chartSettings.fontFamily)
                .style("border", "1px solid #ccc")
                .style("border-radius", "3px")
                .style("padding", "0 2px")
                .style("box-sizing", "border-box");

            input.node().focus();
            input.node().select();

            const finishEditing = () => {
                const newValue = input.property("value");
                if (newValue !== d.label) {
                    d.label = newValue;
                    const allData = svg.node().__data__;
                    const nodeInData = allData.nodes.find(n => n.id === d.id);
                    if (nodeInData) nodeInData.label = newValue;
                    svg.node().__data__ = allData;
                    renderSankey(allData);
                } else {
                    foreignObject.remove();
                    textElement.style("display", null);
                }
            };
            
            const cancelEditing = () => {
                foreignObject.remove();
                textElement.style("display", null);
            };

            input.on("blur", finishEditing).on("keydown", (event) => {
                if (event.key === "Enter") { 
                    event.preventDefault(); 
                    finishEditing(); 
                }
                else if (event.key === "Escape") { 
                    cancelEditing();
                }
            });
        }


        function showEditorPanel(linkData) {
            selectedLinkData = linkData;
            const style = linkData.style;
            
            colorPicker.value = style.color;
            opacitySlider.value = style.opacity;
            opacityValueSpan.textContent = parseFloat(style.opacity).toFixed(2);
            widthSlider.value = Math.round(style.width);
            widthValueSpan.textContent = Math.round(style.width);
            borderColorPicker.value = style.borderColor;
            borderWidthSlider.value = style.borderWidth;
            borderWidthValueSpan.textContent = parseFloat(style.borderWidth).toFixed(1);

            const sourceNode = svg.node().__data__.nodes.find(n => n.id === linkData.source);
            const targetNode = svg.node().__data__.nodes.find(n => n.id === linkData.target);
            const labelText = `${sourceNode.label} → ${targetNode.label}`;
            editingLabel.textContent = labelText;
            editingLabel.title = labelText;
            
            editorPanel.classList.remove('opacity-0', 'translate-x-12', 'pointer-events-none');
        }

        function hideEditorPanel() {
            selectedLinkData = null;
            editorPanel.classList.add('opacity-0', 'translate-x-12', 'pointer-events-none');
        }
        
        function updateLinkStyle(property, value) {
            if (!selectedLinkData) return;
            selectedLinkData.style[property] = value;
            renderSankey(svg.node().__data__);
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            currentFileName = file.name.replace('.json', '_modified.json');
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    data.links.forEach(link => {
                        if (!link.style) link.style = {};
                        if (link.style.borderColor === undefined) link.style.borderColor = '#000000';
                        if (link.style.borderWidth === undefined) link.style.borderWidth = 0;
                    });
                    svg.node().__data__ = data;
                    placeholder.style.display = 'none';
                    renderSankey(data);
                    exportJsonBtn.disabled = false;
                    exportSvgBtn.disabled = false;
                } catch (error) {
                    placeholder.textContent = `Error: Could not parse JSON file. ${error.message}`;
                    placeholder.style.display = 'flex';
                    console.error("JSON parsing error:", error);
                    exportJsonBtn.disabled = true;
                    exportSvgBtn.disabled = true;
                }
            };
            reader.readAsText(file);
        }

        function exportModifiedJSON() {
            const dataToExport = svg.node().__data__;
            if (!dataToExport) {
                alert("No data to export.");
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", currentFileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function exportSVG() {
            const svgEl = svg.node();
            if (!svgEl || !svg.node().__data__) {
                alert("No chart to export.");
                return;
            }

            // Get the bounding box of the actual content
            const contentGroup = svgEl.querySelector("#sankey-content");
            if (!contentGroup) {
                alert("Could not find chart content to export.");
                return;
            }
            const bbox = contentGroup.getBBox();
            const padding = 10; // Add some padding around the content

            const svgClone = svgEl.cloneNode(true);
            svgClone.setAttribute("xmlns", "http://www.w3.org/2000/svg");
            
            // Adjust width, height, and viewBox for cropping
            svgClone.setAttribute("width", bbox.width + padding * 2);
            svgClone.setAttribute("height", bbox.height + padding * 2);
            svgClone.setAttribute("viewBox", `${bbox.x - padding} ${bbox.y - padding} ${bbox.width + padding * 2} ${bbox.height + padding * 2}`);


            const styles = `
                .sankey-link { fill: none; }
                .sankey-node rect { stroke: #333; stroke-width: 1px; }
                .sankey-node text {
                    font-family: ${chartSettings.fontFamily};
                    text-shadow: 0 1px 0 #fff;
                }
            `;
            const styleEl = document.createElement('style');
            styleEl.textContent = styles;

            let defsEl = svgClone.querySelector('defs');
            if (!defsEl) {
                defsEl = document.createElement('defs');
                svgClone.insertBefore(defsEl, svgClone.firstChild);
            }
            defsEl.appendChild(styleEl);

            const svgString = new XMLSerializer().serializeToString(svgClone);
            const blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
            
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = currentFileName.replace('_modified.json', '.svg').replace('.json', '.svg');
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

